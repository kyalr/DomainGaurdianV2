
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Domain Gaurdian</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script type="text/javascript" src="taskpane.js"></script>
    <script src="https://kit.fontawesome.com/8f86fe6637.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="//ej2.syncfusion.com/javascript/demos/spreadsheet/default/datasource.js" type="text/javascript"></script>
    <script src="https://cdn.syncfusion.com/ej2/24.1.41/dist/ej2.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <link href="https://cdn.syncfusion.com/ej2/24.1.41/material.css" rel="stylesheet">

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="test.css" rel="stylesheet" />
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

</head>


<body>

    <header >
        <div class="header-container">
            <img id="DigitalSolutions" src = "https://kyalr.github.io/DomainGaurdianV2/assets/Consillience.png">
            </button>
          </div>
          <br>
    </header>

    <div class="form-container">
        <!-- First Form -->
        <div class="form-wrapper" id="first-form" style="width: 18%; ">

            <div id="reportList" class="report-container"></div>
        </div>
        <div id="staticCard" class="card-container" >
            
            <form id="taskForm" class="modern-form">

                
        </form>

        </div> <!-- New Card -->
        <button id="toggle-flyout" class="toggle-flyout-button"><i class="fa-solid fa-up-right-and-down-left-from-center"></i></button>
        <!-- Resizable Divider -->
        <div class="resizable-divider" id="divider"></div>
        <!-- Second Form (for comments) -->
        <div class="form-wrapper" id="second-form" >
            <div class="illgal_overlay"><label>THIS PAGE CANNOT BE EDITED</label></div>
            <button class="fullscreen-button" id="fullscreen-btn">â›¶</button>
            <label class="switch" id="modeSwitch" style="display: none;">
                <input type="checkbox" id="toggleSwitch" onclick="toggleMode()">
                <span class="slider">
                    <span class="slider-text" data-on="Edit" data-off="View"></span>
                </span>
            </label>
            <div id="loading-overlay" class="loading-overlay">
                <div class="loading-spinner">
                    <img class="rotating-image" style="height: 60px;" src="https://kyalr.github.io/DomainGaurdianV2/assets/ConsilienceIcon.png" alt="Loading..." />
                </div>
            </div>
            <div id="embed-container" style="height: 100%;">

                <label id="SelectReport"><i class="fa-solid fa-person-military-pointing fa-bounce"></i> Please select a Report ...</label>
            </div>
            <div class="error-container" id="error-container">
                <div class="error-content">
                    <div class="error-header">
                        <i class="fa-solid fa-circle-exclamation fa-shake fa-2xl" style="color: #ff6b6b; display: inline-block; font-size: 55px; padding-top: 5px;"></i>
                        <h1 class="error-code" style="display: inline-block;">Error...</h1>
                    </div>
                    <p class="error-message">Oops! The report could not be loaded. Please ensure you have access.</p>
                </div>
            </div>
        </div>
    </div>

    <button class="floating-btn" onclick="getAllFormsForNode()">
        <i class="fa fa-plus"></i> <!-- Font Awesome Icon -->
      </button>

      
    <form id="dynamicForm"></form>
            

        <p id="notification" class="notification"></p>


        <div id="formPopup" class="modal">
            <div class="modal-content">
                <label style="align-items: left; font-size: 20px;">Select an Option</label>
                <span class="close">&times;</span>

              <div id="formButtonsContainer">
                <!-- Buttons will be dynamically added here -->
              </div>
            </div>
          </div>




          
</body>

</html>
<script src="https://unpkg.com/powerbi-client"></script>

<script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.18.0/dist/powerbi.min.js"></script>

<script async defer crossorigin="anonymous"src="https://connect.facebook.net/en_US/sdk.js"></script>

<script>

    models = window['powerbi-client'].models;



    var StratCloudToken;
    var taskName;
    var taskStarErrtDate;
    var taskEndDate;
    var note;
    var noteOrganizationUnitID;
    var noteId;
    var notesEnabled;

    var WO;
    var DESC;
    var Plnt;
    var Type;
    var CRTD;
    var BasicStart;
    var Schedule;
    var ReqDate;
    var ABC;
    var PRI;
    var comment;
    var CommentID;

    var surveyCreateVsUpdate;
    var surveyUserToken;
    var organizationUnit;
    var reportId;
    var formResultId;
    var userSurveyId;

    var tenantName;

    var Action;
    var ActionDescription;
    var agreedActionDate;
    var actionId;
    var actionStatus;

    var validatedSurveyToken;
    var selectedFormId;
    var currentUser;

    var visualNameForExport;

    let pageChangedListenerAdded = false; // To track whether the pageChanged listener has been added

function toggleMode() {
    const toggleSwitch = document.getElementById("toggleSwitch");
    const overlay = document.querySelector(".illgal_overlay");

    // Flag to manage edit mode state
    let isInEditMode = false;

    // Event handler for overlay click
    const showNotificationHandler = function () {
        showNotification("<i class='fa-solid fa-exclamation fa-shake'></i> This page cannot be edited", 'error');
    };

    if (toggleSwitch.checked) {
        // Switch to edit mode and add page
        report.switchMode("edit");

        report.addPage("Authoring Page");


        if (!isInEditMode) {
            // Add pageChanged listener only when in edit mode
            report.on("pageChanged", function (event) {
                const page = event.detail.newPage;
                if (page.displayName === "Authoring Page") {
                    console.log("Legal");
                    overlay.style.display = "none"; // Hide overlay if legal
                    overlay.removeEventListener('click', showNotificationHandler); // Remove click event listener
                } else {
                    console.log("Illegal");
                    overlay.style.display = "block"; // Show overlay if illegal
                    overlay.addEventListener('click', showNotificationHandler); // Add click event listener
                }
            });

            isInEditMode = true; // Set flag to true indicating we're in edit mode
        }
    } else {
        // Switch to view mode
        report.switchMode("view");
        console.log("View mode enabled");

        // Ensure overlay is hidden in view mode
        overlay.style.display = "none"; 

        // Remove the pageChanged listener when switching to view mode
        report.off("pageChanged");

        // Ensure no overlay click event listener is attached when in view mode
        overlay.removeEventListener('click', showNotificationHandler);

        isInEditMode = false; // Reset the flag for view mode
    }
}

    Office.onReady(async (info) => {
            if (info.host === Office.HostType.Outlook) {
                console.log("Office is ready in the new window");

                // Now you can access the mailbox item
                let item = Office.context.mailbox.item;

                // Example: Reading the subject of the email
                console.log("Email Subject:", item.subject);
            }
        });

        async function addExportedDataToEmail() {
            // You would typically use the same logic here to fetch data and then add to email body
            // For demonstration, let's assume you have some data to add to the body
            const dataToAdd = "This is some data to add to the email body.";

            // Check if the item is an email
            if (Office.context.mailbox.item.itemType === Office.MailboxEnums.ItemType.Message) {
                Office.context.mailbox.item.body.setAsync(dataToAdd, { coercionType: Office.CoercionType.Text }, (result) => {
                    if (result.status === Office.AsyncResultStatus.Succeeded) {
                        console.log("Data successfully added to email body.");
                    } else {
                        console.log("Failed to add data to email body:", result.error);
                    }
                });
            } else {
                console.log("Not a message item. Cannot add data to the body.");
            }
        }

    document.getElementById('toggle-flyout').addEventListener('click', function() {
        const formWrapper = document.getElementById('first-form');
        formWrapper.classList.toggle('flyout-visible');
    });

    // Function to create form inputs based on the type
    function createInput(field) {
    
    let input;

    if (field.type === 'text' && field.inputType === 'date') {
        // Date input
        input = document.createElement('input');
        input.type = 'date';
    } 
    else if (field.type === 'text' && field.inputType === 'datetime-local') {
        // Date and time input
        input = document.createElement('input');
        input.type = 'datetime-local'; // HTML5 datetime input
    }
    else if (field.type === 'text' && field.inputType === 'color') {
        // Color input (color picker)
        input = document.createElement('input');
        input.type = 'color'; // HTML5 color input
    }
    else if (field.type === 'dropdown') {
        // Dropdown (select element)
        input = document.createElement('select');
        field.choices.forEach(choice => {
            const option = document.createElement('option');
            if (typeof choice === 'string') {
                option.value = choice;
                option.text = choice;
            } else {
                option.value = choice.value;
                option.text = choice.text;
            }
            input.appendChild(option);
        });
    } else if (field.name.toLowerCase() === 'comment') {
        // Create a textarea for comments
        input = document.createElement('textarea');
        input.rows = 4;  // Set default rows
        input.style.resize = 'vertical';  // Allow vertical resizing
    } else if (field.type === 'boolean') {
        // Create a dropdown for Yes/No
        input = document.createElement('select');
        
        const yesOption = document.createElement('option');
        yesOption.value = 'true';
        yesOption.textContent = field.labelTrue || "Yes";
        input.appendChild(yesOption);

        const noOption = document.createElement('option');
        noOption.value = 'false';
        noOption.textContent = field.labelFalse || "No";
        input.appendChild(noOption);}
     else {
        // Default to a text input
        input = document.createElement('input');
        input.type = 'text';
    }

    // Add required attribute if applicable
    if (field.isRequired) {
        input.required = true;
    }

    input.name = field.name;
    input.placeholder = field.title;
    return input;
}

    function getAllFormsForNode() {
        const myHeaders = new Headers();
        myHeaders.append("accept", "text/plain");
        myHeaders.append("X-XSRF-TOKEN", "null");
        myHeaders.append("Authorization", "Bearer " + StratCloudToken);

        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };

        fetch(`https://${tenantName}.strategnosportal.co.za/api/services/app/Forms/GetFormsByOrganizationUnitIdAndChildren?organizationUnitId=${organizationUnit}`, requestOptions)
            .then(response => response.json()) // Parse JSON
            .then(result => {
                if (result.success) {
                    displayFormsPopup(result.result); // Call function to display the pop-up
                } else {
                    console.error('Error fetching forms:', result.error);
                }
            })
            .catch(error => console.error('API call failed:', error));
    }

    function getTokenForSelectedForm(event){
        debugger;
        event.preventDefault();
        const myHeaders = new Headers();
        myHeaders.append("accept", "text/plain");
        myHeaders.append("Content-Type", "application/json-patch+json");
        myHeaders.append("X-XSRF-TOKEN", "null");
        myHeaders.append("Authorization", "Bearer " + StratCloudToken);
       

        const raw = JSON.stringify({
        "resultId": null,
        "surveyId": selectedFormId,
        "type": 1,
        "behaviour": 3,
        "expiresAfterNSeconds": "86400",
        "organizationUnitId": organizationUnit
        });

        const requestOptions = {
        method: "POST",
        headers: myHeaders,
        body: raw,
        redirect: "follow"
        };

        fetch(`https://${tenantName}.strategnosportal.co.za/api/services/app/SurveysToken/Create`, requestOptions)
        .then((response) => response.json())
        .then((result) => {
            if (result.success) {
                let surveyToken;
                surveyToken = result.result;
                validateTokenForSelectedForm(surveyToken)
            }
            else {
                console.error("First API call failed", result);
            }
        })
        .catch((error) => console.error(error));
    }

    function validateTokenForSelectedForm(surveyToken){
        const myHeaders = new Headers();
        myHeaders.append("accept", "text/plain");
        myHeaders.append("Content-Type", "application/json-patch+json");
        myHeaders.append("X-XSRF-TOKEN", "null");

        const raw = JSON.stringify({
        "token": surveyToken,
        "userId": null
        });

        const requestOptions = {
        method: "POST",
        headers: myHeaders,
        body: raw,
        redirect: "follow"
        };

        fetch(`https://${tenantName}.strategnosportal.co.za/api/services/app/SurveysToken/Validate`, requestOptions)
        .then((response) => response.json())
        .then((result) => {
            console.log(result.result.token);
            validatedSurveyToken = result.result.token;
            updateSurveyResult(validatedSurveyToken);
        })
        .catch((error) => console.error(error));
    }



    function displayFormsPopup(forms) {
        // Get the modal
        console.log(forms)
        const modal = document.getElementById("formPopup");
        const formButtonsContainer = document.getElementById("formButtonsContainer");

        // Clear any existing buttons
        formButtonsContainer.innerHTML = "";

        forms.forEach(form => {
        const button = document.createElement('button');
        button.className = "node-button";

        // Create the icon element
        const icon = document.createElement('i');
        icon.className = "fa-regular fa-pen-to-square"; // Add the Font Awesome icon classes

        // Create a span for the text
        const buttonText = document.createElement('span');
        buttonText.textContent = form.name;

        // Append icon and text to the button
        button.appendChild(icon);
        button.appendChild(buttonText);

        // Set button onclick event
        button.onclick = function() {
            debugger;
            selectedFormId = '';
            handleFormSelection(form.id); // Function to handle the form selection
            localStorage.setItem("SelectedFormId", form.id)
        };

    formButtonsContainer.appendChild(button);
    });

        // Display the modal
        modal.style.display = "block";

        // Close modal when the 'x' is clicked
        const closeButton = document.getElementsByClassName("close")[0];
        closeButton.onclick = function() {
            modal.style.display = "none";
        };

        // Close modal if user clicks outside of the modal
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        };
    }


    function handleFormSelection(formId) {
        console.log('Selected form ID:', formId);
        selectedFormId = formId;
        const modal = document.getElementById("formPopup");
        const formWrapper = document.getElementById('first-form');
        const myHeaders = new Headers();
        myHeaders.append("accept", "application/json"); // Expecting JSON response
        myHeaders.append("X-XSRF-TOKEN", "null");
        myHeaders.append("Authorization", "Bearer " + StratCloudToken);

        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };

        fetch(`https://${tenantName}.strategnosportal.co.za/api/services/app/Forms/GetFormBlueprint?formId=${formId}`, requestOptions)
        .then((response) => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();  // Automatically parse JSON
        })
        .then((data) => {
            // Handle the API response structure
            if (data.success) {
                const surveyData = data.result;  // Extract the actual data from result
                buildSurvey(surveyData);  // Assuming buildSurvey expects this structure
                modal.style.display = "none";
                if (formWrapper.classList.contains('flyout-visible')) {
                    formWrapper.classList.remove('flyout-visible');  // Close the form if it's open
                }
            } else {
                console.error('Error in the response:', data.error);
            }
        })
        .catch((error) => {
            console.error('There was a problem with the fetch operation:', error);
        });
    }

    function buildSurvey(result) {
    const surveyBlueprint = result;

    const form = document.getElementById('taskForm'); // Get the form element
    form.innerHTML = ''; 

    console.log(surveyBlueprint);

    surveyBlueprint.pages.forEach(page => {
        page.elements.forEach(element => {
            // Only create the input if visible is true or null
            if (element.visible !== false) {
                // Create a div with the form-group class
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';

                // Create the label
                const label = document.createElement('label');
                label.textContent = element.title;
                label.className = 'form-label'; // Apply the form-label class
                label.id = element.title + 'label';

                // Create the input
                const input = createInput(element);
                input.className = 'form-control'; // Apply the form-control class
                input.id = element.title;
                
                // Append label and input to the form group
                formGroup.appendChild(label);
                formGroup.appendChild(input);

                // Append the form group to the form
                form.appendChild(formGroup);
            }
        });
    });

    // Append the button container after the form content
    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'button-container';

    // Create the Save button
    const saveButton = document.createElement('button');
    saveButton.id = 'submitComment';
    saveButton.className = 'cta-button';

    // Create the Save icon
    const saveIcon = document.createElement('i');
    saveIcon.className = 'fa-regular fa-floppy-disk'; // Icon class for save
    saveButton.appendChild(saveIcon); // Append the icon to the button

    // Add text to the button after the icon
    saveButton.appendChild(document.createTextNode(' Save'));
    saveButton.onclick = (event) => getTokenForSelectedForm(event); // Change to your save function

    // Create the Clear button
    const clearButton = document.createElement('button');
    clearButton.id = 'clearInputs';
    clearButton.className = 'cta-button';

    // Create the Save icon
    const clearIcon = document.createElement('i');
    clearIcon.className = "fa-solid fa-eraser"; // Icon class for save
    clearButton.appendChild(clearIcon); // Append the icon to the button

    clearButton.appendChild(document.createTextNode(' Clear'));
    clearButton.onclick = (event) => {
        // Clear all inputs in the form
        event.preventDefault();
        const inputs = form.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.value = ''; // Clear the input value
        });
    };

    // Append both buttons to button container
    buttonContainer.appendChild(saveButton);
    buttonContainer.appendChild(clearButton);


    // Finally append the button container to the form
    form.appendChild(buttonContainer);
}


    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const myVariable = urlParams.get('scToken');
        StratCloudToken = urlParams.get('scToken');
        organizationUnit = urlParams.get('organizationUnit');
        tenantName = urlParams.get('tenantName');

        document.getElementById("SelectReport").style.display = 'none';

        getAvailableReportsForNode();
        getCurrentLoginInfo();

    };

    function openSpreadsheet(jsonData, fileInput) {
        ej.base.enableRipple(true);
        //Initialize Spreadsheet component
        var spreadsheet = new ej.spreadsheet.Spreadsheet({
            sheets: [
                {
                    name: 'Sheet 1',
                    ranges: [{ dataSource: jsonData }],
                }
            ],
            openUrl: 'https://services.syncfusion.com/js/production/api/spreadsheet/open',
            saveUrl: 'https://strategnos.sharepoint.com/sites/IT/_layouts/15/download.aspx?UniqueId=2cd3b7d3-3e24-4d5d-b6f5-e02dd376d936&Translate=false&tempauth=v1.eyJzaXRlaWQiOiI2YjQ5MDExMS1iZDE1LTQyZTktOGRlNy0yMDFmZjM1Nzg5M2MiLCJhcHBfZGlzcGxheW5hbWUiOiJTaGFyZVBvaW50QXBwIiwiYXVkIjoiMDAwMDAwMDMtMDAwMC0wZmYxLWNlMDAtMDAwMDAwMDAwMDAwL3N0cmF0ZWdub3Muc2hhcmVwb2ludC5jb21AODU4YTJiZDMtZmNkMi00NWVlLWI0NmMtZjkzNDgwM2JkMGIyIiwiZXhwIjoiMTcxOTgxODUwOCJ9.CgoKBHNuaWQSAjY0EgsInLKl84PojD0QBRoNMjAuMTkwLjE5MC4zNSosOGkycytQWU9BK3BJQjM3RzdOc0pJdlN3TDRNbUU3K2RHblNBM2xnUnkvbz0wggE4AUIQoTfyHB7gAJA_GTPZzb3KckoQaGFzaGVkcHJvb2Z0b2tlbnoBMboBH2FsbHNpdGVzLndyaXRlIGFsbHByb2ZpbGVzLnJlYWTCAUlkMTQ0ZDM0OC1iZTBiLTQ4MTUtYjM5YS02YjgyZjViZTY3N2JAODU4YTJiZDMtZmNkMi00NWVlLWI0NmMtZjkzNDgwM2JkMGIyyAEB.rwAO_IeK2AjXCkGJ6TH6_HNC1kSPta-TjnF0DHvn1Sg&ApiVersion=2.0',

        });
        //Render initialized Spreadsheet component
        spreadsheet.appendTo('#spreadsheet');
        console.log(spreadsheet)
        console.log(spreadsheet.workbookSaveModule.saveJSON.toString())
    }



    function embedReport(myVariable, reportId) {
        const myHeaders = new Headers();
        myHeaders.append("accept", "text/plain");
        myHeaders.append("Authorization", "Bearer " + myVariable);

        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };

        fetch(`https://${tenantName}.strategnosportal.co.za/api/services/app/TenantDashboard/GetReportEmbedInfo?reportId=${reportId}`, requestOptions)
            .then((response) => {
                if (!response.ok) {
                    // If the response status is not ok (e.g., 4xx or 5xx), throw an error
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json(); // Parse response as JSON if status is ok
            })
            .then((data) => {

                // Get a reference to the embedded report HTML element
                let embedContainer = document.getElementById("embed-container");
                
                powerbi.reset(embedContainer);

                document.getElementById('error-container').style.display = 'none';

                const embedToken = data.result.embedParams.embedToken.token;
                const embedUrl = data.result.embedParams.embedReport[0].embedUrl;
                const reportId = data.result.embedParams.embedReport[0].reportId;

                let config = {
                    type: 'report',
                    accessToken: embedToken,
                    embedUrl: embedUrl,
                    tokenType: 1,
                    id: reportId,
                    permissions: models.Permissions.All,
                    viewMode: models.ViewMode.view,
                    settings: {
                        displayOption: models.DisplayOption.FitToPage,
                        panes: {
                            filters: {
                                visible: false
                            },
                            pageNavigation: {
                                visible: true
                            }
                        },
                        bars: {
                            statusBar: {
                                visible: false
                            }
                        },
                        extensions: [
                            {
                                command: {
                                    name: "campaign",
                                    title: "Start campaign",
                                    icon: 'ALT',
                                    extend: {
                                        visualOptionsMenu: {
                                            title: "Export to Email"
                                        }
                                    }
                                }
                            }]
                            
                    }
                };

                const urlParams = new URLSearchParams(window.location.search);
                const nodeId = urlParams.get('nodeId');
                
                var nodeIdNumber = nodeId;

                // Embed the report and display it within the div container.
                report = powerbi.embed(embedContainer, config);

                // Apply the filter once the report is loaded
                report.on("loaded", function() {    
                    document.getElementById('embed-container').style.visibility = 'visible'
                    embedContainer.style.display = 'block';
                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('fullscreen-btn').style.display = 'block';
                    document.getElementById("modeSwitch").style.display = "inline-block";

                });

                // report.on will add an event listener.
                report.on("dataSelected", function (event) {
                    let data = event.detail;

                    if(data.visual.name === 'ecac59bf8de8f69b052e' || data.visual.name === '927a5a72a5fbc34ebe65' || data.visual.name === "b8172d6fda60ae0cb807"){

                        surveyCreateVsUpdate = 'create';
                               
                    
                            if(data.visual.name === "927a5a72a5fbc34ebe65"){
                                CommentID = data.dataPoints[0].values[0].formattedValue;
                                document.getElementById('Work Order Number').value = WO;
                                WO = data.dataPoints[0].identity[0].equals;
                                DESC = data.dataPoints[0].identity[1].equals;
                                Plnt = data.dataPoints[0].identity[2].equals;
                                Type = data.dataPoints[0].identity[3].equals;
                                CRTD = data.dataPoints[0].identity[4].equals;
                                BasicStart = data.dataPoints[0].identity[5].equals;
                                Schedule = data.dataPoints[0].identity[6].equals;
                                ReqDate = data.dataPoints[0].identity[7].equals;
                                ABC = data.dataPoints[0].identity[8].equals;
                                PRI = data.dataPoints[0].identity[9].equals;      
                            }
                            else if(data.visual.name === "b8172d6fda60ae0cb807"){
                                CommentID = data.dataPoints[0].identity[3].equals;
                                document.getElementById('Work Order Number').value = CommentID;
                            }

                    }
                    else if (data.visual.name === 'b3f3f31a308ce0d94399'){
                        console.log(data)
                        surveyCreateVsUpdate = "update"

                        agreedActionDate = data.dataPoints[0].identity[0].equals;
                        Action = data.dataPoints[0].identity[1].equals;
                        ActionDescription = data.dataPoints[0].identity[2].equals;
                        agreedActionDate = data.dataPoints[0].identity[3].equals;
                        actionStatus = data.dataPoints[0].identity[4].equals;
                        formResultId = data.dataPoints[0].identity[5].equals;

                        document.getElementById('Action').value = Action;
                        document.getElementById('Action Description').value = ActionDescription;
                        document.getElementById('Agreed Action Date').value = agreedActionDate;
                        document.getElementById('Status').value = actionStatus;
                        
                    }
                    else{
                        console.log("Wrong Visual")
                    }
                });

                report.on("commandTriggered", async function (event) {
                    let commandDetails = event.detail;
                    console.log("Event - commandTriggered:\n", commandDetails);
                    visualNameForExport = commandDetails.visual.name;

                    // Retrieve the page collection and get the visuals for the active page.
                    try {
                        const pages = await report.getPages();

                        // Retrieve the page that contain the visual. For the sample report it will be the active page
                        let page = pages.filter(function (page) {
                            return page.isActive
                        })[0];

                        const visuals = await page.getVisuals();

                        // Retrieve the target visual.
                        let visual = visuals.filter(function (visual) {
                            return visual.name === visualNameForExport;
                        })[0];

                        const result = await visual.exportData(models.ExportDataType.Summarized);
                        console.log(result.data);

                        copyToClipboard(result.data)

                    }
                    catch (errors) {
                        console.log(errors);
                    }

                })

                report.on("buttonClicked", async function (event) {
                        try {
                            await report.refresh();
                            console.log("Refreshed");
                        }
                        catch (errors) {
                            console.log(errors);
                        }
                });
                
            }).catch((error) => {
                // Handle errors
                let embedContainer = document.getElementById("embed-container");
                powerbi.reset(embedContainer);
                embedContainer.style.display = 'none'
                console.error('There was a problem with the fetch operation:', error);
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('fullscreen-btn').style.display = 'block';
                document.getElementById('error-container').style.display = 'flex';
            });
    }

    function createTableHTML(data) {
        const rows = data.split('\n').map(row => row.split(','));
            let table = `<table style="border-collapse: collapse; width: auto; table-layout: auto;">`;
            rows.forEach((row, index) => {
                table += `<tr>`;
                row.forEach(cell => {
                    const tag = index === 0 ? 'th' : 'td'; // Header for the first row
                    const headerStyle = index === 0 
                        ? 'background-color: #add8e6; padding: 4px; font-size: 12px;' // Smaller header style
                        : 'padding: 4px; font-size: 14px;'; // Normal row style
                    table += `<${tag} style="border: 1px solid #dddddd; text-align: left; ${headerStyle}">${cell.trim()}</${tag}>`;
                });
                table += `</tr>`;
            });
            table += `</table>`;
            return table;
        }

        function copyToClipboard(data) {
            const tableHTML = createTableHTML(data);
            const tempElement = document.createElement('div');
            tempElement.innerHTML = tableHTML;
            document.body.appendChild(tempElement);
            
            // Create a range and select the table
            const range = document.createRange();
            range.selectNode(tempElement);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);

            // Copy to clipboard
            document.execCommand('copy');
            console.log("Table copied to clipboard!");

            saveTableDataToLocalStorage(data);

            // Clean up
            document.body.removeChild(tempElement);
            window.getSelection().removeAllRanges();
        }

        function saveTableDataToLocalStorage(data) {
            try {
                // Assuming 'data' is an array of arrays (rows of the table)
                localStorage.setItem('tableData', data);
                console.log("Table data saved to local storage!");
            } catch (error) {
                console.error("Failed to save table data to local storage:", error);
            }
        }

        function openCommandsPage() {
            const url = 'commands.html'; // Adjust the path as needed
            window.open(url, '_blank'); // Opens commands.html in a new tab
        }

    
    function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.className = 'notification'; // reset classes
            notification.classList.add(type);
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
        }, 3000);
    }





function updateSurveyResult(validatedSurveyToken){
    console.log(CommentID)
    const myHeaders = new Headers();
    myHeaders.append("accept", "*/*");
    myHeaders.append("Content-Type", "application/json-patch+json");
    myHeaders.append("X-XSRF-TOKEN", "null");
    myHeaders.append("Authorization", "Bearer " + StratCloudToken);

    showNotification("<i class='fa-solid fa-spinner fa-spin'></i>", 'loading')

    if(CommentID === undefined){
        showNotification("<i class='fa-solid fa-exclamation fa-shake'></i> Please select a work order", 'error')
    }
    else{

        let raw;

        if (surveyCreateVsUpdate == "update") {
            // Perform your update logic here, e.g., call a different function
            handleSurveyUpdate(selectedFormId);
            return; // Exit the current function after handling the update
        }

        if(selectedFormId == "62c4f4a3-f46f-4a9a-6681-08dcf19962c1" & surveyCreateVsUpdate == "create"){
            raw = JSON.stringify({
            "verifiedToken": validatedSurveyToken,
            "surveyResultsAsJson": JSON.stringify({
                    "WorkOrderNumber": WO,
                    "Id": CommentID,
                    "Comment": document.getElementById('Comment').value
                }),
            });
        } else if (selectedFormId == "36bc4055-83ca-4e55-8839-08dcf3f168f9" & surveyCreateVsUpdate == "create"){
            raw = JSON.stringify({
            "verifiedToken": validatedSurveyToken,
            "surveyResultsAsJson": JSON.stringify({
                    "Action": document.getElementById('Action').value,
                    "AgreedActionDate": document.getElementById('Agreed Action Date').value,
                    "question1": document.getElementById('Action Description').value,
                    "Id": CommentID,
                    "Status": document.getElementById('Status').value,
                    "Flag": document.getElementById('Flag').value,
                    "ResposiblePerson": document.getElementById('Responsible Person').value
                }),
            });
        }
        else if (selectedFormId == "a31a0398-b597-4321-e343-08dc9f3c4ca5" & surveyCreateVsUpdate == "create"){
            raw = JSON.stringify({
            "verifiedToken": validatedSurveyToken,
            "surveyResultsAsJson": JSON.stringify({
                    "reorderPoint": document.getElementById('Re-Order Point').value,
                    "max":document.getElementById('Max').value,
                    "leadTime": document.getElementById('Lead Time').value,
                    "mrpType": document.getElementById('MRP Type').value,
                    "outputType": document.getElementById('Ouput Type').value,
                    "Id": CommentID
                }),
            });
        }


        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
        };

        fetch(`https://${tenantName}.strategnosportal.co.za/api/services/app/SurveysToken/SaveCompletedSurveyResults`, requestOptions)
        .then((response) => response.json())
        .then((result) => {
            if(result.success){
                console.log(result.success)
                showNotification("<i class='fa-regular fa-thumbs-up fa-bounce'></i> Created successfully!", 'success')
            }
            else{
                console.log(result)
                showNotification("<i class='fa-solid fa-exclamation fa-shake'></i> Result cannot be saved", 'error')
            }
            })
            .catch((error) => 
                showNotification("<i class='fa-solid fa-exclamation fa-shake'></i> Result cannot be saved", 'error')
            );
    }
}
          
function handleSurveyUpdate(selectedFormId){
    debugger;
    const myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");
    myHeaders.append("Authorization", "Bearer " + StratCloudToken);

    const raw = JSON.stringify({
        "formResultId": formResultId,
        "organizationUnitId": organizationUnit,
        "formId": selectedFormId,
        "formUserId": "d4928d79-f735-4504-2527-08dcf4c414cf",
        "formResultsAsJson": JSON.stringify({
                "Action": document.getElementById('Action').value,
                "question1": document.getElementById('Action Description'),
                "AgreedActionDate":document.getElementById('Agreed Action Date').value,
                "Status": document.getElementById('Status').value,
            }),
        "existingRecord": true
    });

    const requestOptions = {
    method: "POST",
    headers: myHeaders,
    body: raw,
    redirect: "follow"
    };

    fetch("https://demo.strategnosportal.co.za/api/services/app/Forms/EditFormTaskResult", requestOptions)
    .then((response) => response.text())
    .then((result) => console.log(result))
    .catch((error) => console.error(error));

    }

function stopResize() {
    isResizing = false;
    document.removeEventListener('mousemove', resize);
    document.removeEventListener('mouseup', stopResize);
}

function getAvailableReportsForNode() {
    const myHeaders = new Headers();
    myHeaders.append("accept", "text/plain");
    myHeaders.append("X-XSRF-TOKEN", "null");
    myHeaders.append("Authorization", "Bearer " + StratCloudToken);

    const requestOptions = {
        method: "GET",
        headers: myHeaders,
        redirect: "follow"
    };

    const nodeId = Number(organizationUnit)

    fetch(`https://${tenantName}.strategnosportal.co.za/api/services/app/OrganizationUnitReporting/GetLinkedOrganizationUnitReports?OrganizationUnitId=${nodeId}`, requestOptions)
        .then((response) => response.json())
        .then((data) => {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('fullscreen-btn').style.display = 'block';
            const reports = data.result.reports.items;
            console.log(reports)
            const reportList = document.getElementById('reportList');
            reports.forEach((report) => {
                if (report.isViewable) {
                    const reportElement = document.createElement('button');
                    reportElement.className = 'node-button';

                    const iconLeft = document.createElement('i');
                    iconLeft.classList.add('fa-regular', 'fa-file-lines');
                    reportElement.appendChild(iconLeft);

                    const textNode = document.createElement('span');
                    textNode.textContent = report.name;
                    reportElement.appendChild(textNode);

                    const iconRight = document.createElement('i');
                    iconRight.classList.add('fa-solid', 'fa-expand');
                    reportElement.appendChild(iconRight);

                    reportList.appendChild(reportElement);
                    reportElement.setAttribute('data-id', report.id);
                    reportElement.addEventListener('click', handleUnitSelection);

                    // Ensure the form is always visible on load with slow animation
                    const formWrapper = document.getElementById('first-form');
                    formWrapper.classList.add('flyout-visible', 'slow-transition');

                    document.getElementById("SelectReport").style.display = 'block'
                }
            });
        })
        .catch((error) => console.error(error));

}

        const divider = document.getElementById('divider');
        const firstForm = document.getElementById('first-form');
        const secondForm = document.getElementById('second-form');
        const container = document.querySelector('.form-container');

        let isResizing = false;

        divider.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            if (!isResizing) return;

            const containerRect = container.getBoundingClientRect();
            const minWidth = 50;  // Minimum width for each form
            const leftWidth = Math.max(e.clientX - containerRect.left, minWidth);
            const rightWidth = containerRect.width - leftWidth - divider.offsetWidth - 10; // 10px is the total gap (5px for each form)

            if (leftWidth >= minWidth && rightWidth >= minWidth) {
                firstForm.style.width = `${leftWidth}px`;
                secondForm.style.width = `${rightWidth}px`;
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }

    function handleUnitSelection(event) {
        // Remove selected class from all buttons
        document.querySelectorAll('.node-button').forEach(button => {
            button.classList.remove('selected');
        });


        // Add selected class to the clicked button
        const clickedButton = event.target.closest('.node-button');
        const buttonId = clickedButton.getAttribute('data-id');

        document.getElementById('loading-overlay').style.display = 'block';
        document.getElementById('fullscreen-btn').style.display = 'none';

        clickedButton.classList.add('selected');
        let embedContainer = document.getElementById("embed-container");
        document.getElementById('error-container').style.display = 'none';
        embedContainer.style.display = 'none';
        powerbi.reset(embedContainer);

        embedReport(StratCloudToken, buttonId)

        const formWrapper = document.getElementById('first-form');
        formWrapper.classList.toggle('flyout-visible');
            
    }


    document.getElementById('fullscreen-btn').addEventListener('click', function () {
    const container = document.getElementById('second-form');

    if (!document.fullscreenElement) {
        // Add fullscreen class for entry animation
        container.classList.add('fullscreen');

        container.requestFullscreen().catch(err => {
            console.error(`Error attempting to enable fullscreen mode: ${err.message}`);
        });
    } else {
        // Add exit class for exit animation
        container.classList.add('exit');

        // Remove fullscreen mode
        document.exitFullscreen().finally(() => {
            // Cleanup classes after animations
            setTimeout(() => {
                container.classList.remove('fullscreen', 'exit');
            }, 300);
        });
    }
});

function getCurrentLoginInfo() {
    const myHeaders = new Headers();
    myHeaders.append("accept", "text/plain");
    myHeaders.append("X-XSRF-TOKEN", "null");
    myHeaders.append("Authorization", "Bearer " + StratCloudToken);

    const requestOptions = {
        method: "GET",
        headers: myHeaders,
        redirect: "follow"
    };

    fetch(`https://${tenantName}.strategnosportal.co.za/api/services/app/Session/GetCurrentLoginInformations`, requestOptions)
        .then((response) => response.json())
        .then((result) => {
            // Extract user name and surname
            console.log(result)
            currentUser = result.result.user.name & " " & result.result.user.surname;
            console.log(currentUser);
        })
        .catch((error) => console.error(error));
}




</script>