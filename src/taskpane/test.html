<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Domain Gaurdian</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script type="text/javascript" src="taskpane.js"></script>
    <script src="https://kit.fontawesome.com/8f86fe6637.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="//ej2.syncfusion.com/javascript/demos/spreadsheet/default/datasource.js" type="text/javascript"></script>
    <script src="https://cdn.syncfusion.com/ej2/24.1.41/dist/ej2.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <link href="https://cdn.syncfusion.com/ej2/24.1.41/material.css" rel="stylesheet">

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">

</head>

<style>

body {
    font-family: 'Sequel Sans Light', sans-serif;
    text-align: center;
    background: linear-gradient(0deg, #9ba7c4 10%, #0d111a 70%);
    background-size: 400% 400%;
    animation: gradientAnimation 15s ease infinite;
    padding: 10px;
    line-height: 1.2;
}

@keyframes gradientAnimation {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

.input-error {
    border-color: #ff6b6b;/* Transparent red placeholder text color */
}

.shake {
    animation: shake 0.5s;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 90% { transform: translateX(-5px); }
    20%, 80% { transform: translateX(5px); }
    30%, 70% { transform: translateX(-3px); }
    40%, 60% { transform: translateX(3px); }
    50% { transform: translateX(0); }
}


.loading-overlay {
    display: block;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgb(7, 7, 28, 0.8); /* Semi-transparent black */
    z-index: 999; /* Ensure it's on top of other elements */
}

.loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}


.form-container {
    display: flex; /* Use flexbox for layout */
    justify-content: space-between; /* Space between forms */
    max-width: 100%; /* Maximum width of form container */
    height: 5%;
}

.form-wrapper {
    flex: 0 0 calc(50% - 8px); /* Two forms in a row */
    background-color: #4e4e4e; /* Dark background color */
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgb(0, 0, 0); /* Adjusted shadow color */
    margin-bottom: 20px; /* Margin between forms */
    color: black;
}

.modern-form {
    /* Basic form styles */
    width: 100%;
}

.form-group {
    margin-bottom: 5%;
    display: flex; /* Use flexbox for horizontal layout */
    align-items: center; /* Center items vertically */
}

label {
    margin-top: 10px;
    flex: 1; /* Take up all available space */
    color: white; /* Light text color */
    font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
    font-size: 6;
}
.form-control {
    margin-top: 5px;
    flex: 2; /* Take up more space than label */
    width: 100%; /* Full width input */
    padding: 5px;
    font-size: 10px;
    border-radius: 4px;
    box-sizing: border-box;
    background-color: #444444; /* Dark input background */
    color: white; /* Light text color */
}

.textarea {
    resize: vertical; /* Allow vertical resizing of textarea */
}

.button-container {
    display: flex;
    justify-content: center; /* Center buttons horizontally */
    gap: 5px; /* Add space between buttons */
}

.cta-button {
    display: inline-block;
    padding: 5px 20px;
    background-color: #D2B08D;
    color: black;
    text-decoration: none;
    border-radius: 8px;
    transition: background-color 0.3s;
    width: 100%; /* Change width to auto */
    margin: 1px; /* Add some margin for spacing between buttons */
}

.cta-button:hover {
    background-color: #ECEDF8;
    color: #33333A;
}

.hidden {
    display: none !important; /* Hide the form using class */
}

.notification {
    visibility: hidden;
    min-width: 250px;
    background-color: #444444; /* Dark background color */
    color: #ffffff; /* Light text color */
    text-align: center;
    padding: 8px;
    position: fixed;
    z-index: 1;
    right: 20px; /* Changed from left: 80% to right: 20px */
    bottom: 20px;
    font-size: 12px;
}

.notification.success {
    background-color: #1bc5bdab; /* Success background color */
    color: #ffffff; /* Light text color */
    border-radius: 8px;
}

.notification.error {
    background-color: #ff6b6b; /* Error background color */
    color: #ffffff; /* Light text color */
    border-radius: 8px;
}

.notification.show {
    visibility: visible;
    animation: fadein 0.5s, fadeout 0.5s 3.5s;
}

@keyframes fadein {
    from {bottom: 0; opacity: 0;} 
    to {bottom: 30px; opacity: 1;}
}

@keyframes fadeout {
    from {bottom: 30px; opacity: 0;} 
    to {bottom: 0; opacity: 0;}
}

#DigitalSolutions{
    height: 52px;
    display: inline-block;
    margin-left: 10px;
}


.header-container {
    display: flex;
    align-items: center;
}

.rotating-image {
    animation: rotate 5s linear infinite;
}

@keyframes rotate {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.cardInput {
    display: none;
    background-color:  #ecedf813;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(1, 0, 0, 0.603);
    margin-bottom: 10px;
    padding: 10px;
}

.cardPowerBi{
    height: 100%;
    background-color: #4444443d;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    padding: 20px;
    display: block;
}

.form-control:focus {
    outline: none;
    box-shadow: 0 0 10px #D2B08D; /* Change the glow color */
}

.error-container {
    display: none;
    background: #fff;
    padding: 40px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    height: 500px;
    flex-direction: column;
    justify-content: center;
    align-items: center; /* Center items horizontally */
    text-align: center;
}

.error-content {
    max-width: 100%;
    
}

.error-code {
    font-size: 72px;
    color: #ff6b6b;
}

.error-message {
    font-size: 15px;
    color: #333;
}

.error-header {
    display: flex;
    justify-content: center;
    align-items: center; /* Align items vertically */
    gap: 10px; /* Add space between the icon and the h1 */
}

#newLineItemButton{
    display: none;
    margin-bottom: 10px;
}


</style>

<body>

    <header >
        <div class="header-container">
            <img id="DigitalSolutions" src = "https://kyalr.github.io/DomainGaurdianV2/assets/Consillience.png">
            </button>
          </div>
          <br>
    </header>

    <div id="reporting">

        <div class="cardInput" id="forms-card">
            <div class="form-container" id="forms">
                <!-- First Form -->
                <div class="form-wrapper">
                    <form id="taskForm" class="modern-form">
                        <div class="form-group">
                            <label for="taskNameInput">Task Name:</label>
                            <input type="text" id="taskNameInput" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="startDateInput">Start Date:</label>
                            <input type="datetime-local" id="startDateInput" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="endDateInput">End Date:</label>
                            <input type="datetime-local" id="endDateInput" class="form-control">
                        </div>
                    </form>
                </div>
            
                <!-- Second Form (for comments) -->
                <div class="form-wrapper">
                    <form id="commentForm" class="modern-form">
                        <div class="form-group">
                            <label for="commentInput">Comments:</label>
                            <textarea id="commentInput" class="form-control textarea" rows="6"></textarea>
                        </div>
                    </form>
                </div>
            </div>
            <div class="button-container">
                <button id="submitComment" class="cta-button" onclick="createOrUpdateNote()">Save</button>
                <button style="background-color: #ECEDF8;" id="closeComment" class="cta-button" onclick="closeComment()">Cancel</button>
            </div>
        </div>
        
        <div class="cardInput" id="survey-card">
            <div class="form-container" id="forms">
                <!-- First Form -->
                <div class="form-wrapper">
                    <form id="taskForm" class="modern-form">
                        <div class="form-group">
                            <label for="taskNameInput">Material Code:</label>
                            <input type="text" id="MaterialCodeInput" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="endDateInput">Reorder Point:</label>
                            <input type="number" id="ReorderPointInput" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="endDateInput">Lead Time:</label>
                            <input type="number" id="LeadTimeInput" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="endDateInput">Max:</label>
                            <input type="number" id="MaxInput" class="form-control" required>
                        </div>
    
                    </form>
                </div>
            
                <!-- Second Form (for comments) -->
                <div class="form-wrapper">
                    <form id="commentForm" class="modern-form">
                        <div class="form-group">
                            <label for="endDateInput">MRP Type:</label>
                            <select id="MRPTypeInput" class="form-control" required>
                                <option value="VB">VB</option>
                                <option value="ZP">ZP</option>
                                <option value="ND">ND</option>
                                <option value="PD">PD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="endDateInput">Output Type:</label>
                            <select id="OutputTypeInput" class="form-control" required>
                                <option value="Lead Time Change">Lead Time Change</option>
                                <option value="MRP Change">MRP Change</option>
                                <option value="Inventory Level Adjustments">Inventory Level Adjustments</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="commentInput">Comments:</label>
                            <textarea id="comment2Input" class="form-control textarea" rows="6"></textarea>
                        </div>
                    </form>
                </div>
            </div>
            <div class="button-container">
                <button id="submitComment" class="cta-button" onclick="updateSurveyResult()">Save</button>
                <button style="background-color: #ECEDF8;" id="closeComment" class="cta-button" onclick="closeSurvey()">Cancel</button>
            </div>
        </div>

        <div class="button-container">
            <button id="newLineItemButton" class="cta-button" onclick="createNewLineItem()"><i class="fa-regular fa-square-plus"></i> New line Item</button>
        </div>

        <div class="error-container" id="error-container">
            <div class="error-content">
                <div class="error-header">
                    <i class="fa-solid fa-circle-exclamation fa-shake fa-2xl" style="color: #ff6b6b; display: inline-block; font-size: 55px; padding-top: 5px;"></i>
                    <h1 class="error-code" style="display: inline-block;">Error...</h1>
                </div>
                <p class="error-message">Oops! The report could not be loaded. Please ensure you have access.</p>
            </div>
        </div>
    
        <div id="cardPowerBi" class="cardPowerBi">
            <div style="height: 450px;" id="embed-container" class="embed-container"></div>
            <div id="loading-overlay" class="loading-overlay">
                <div class="loading-spinner">
                    <img class="rotating-image" style=" height: 60px;" src="https://kyalr.github.io/DomainGaurdianV2/assets/ConsilienceIcon.png" alt="Loading..." />
                </div>
            </div>
        </div>
    
        <div style="width: 100%; height: 1000px; padding-left: 20px;">
            <div>
                <div>
                    <h1 style="padding-left: 20px;"></h1>
                    <div id="spreadsheet" style="height: 1000px;"></div>
                </div>
            </div>
        </div>

        <p id="notification" class="notification"></p>
</body>

</html>
<script src="https://unpkg.com/powerbi-client"></script>

<script src="https://cdn.jsdelivr.net/npm/powerbi-client@2.18.0/dist/powerbi.min.js"></script>

<script>

    models = window['powerbi-client'].models;

    var StratCloudToken;
    var taskName;
    var taskStarErrtDate;
    var taskEndDate;
    var note;
    var noteOrganizationUnitID;
    var noteId;
    var notesEnabled;

    var materialCode;
    var reorderPoint;
    var leadTime;
    var max;
    var mrpType;
    var outputType;
    var comments;
    var userSurveyId;
    var surveyOrganizationUnitId

    var surveyCreateVsUpdate;
    var surveyUserToken;
    var organizationUnit;

    function closeComment(){
        document.getElementById('forms-card').style.display = 'none';
    }

    function closeSurvey(){
        document.getElementById('survey-card').style.display = 'none';
        document.getElementById('newLineItemButton').style.display = 'block';

        const inputs = [
            document.getElementById('MaterialCodeInput'),
            document.getElementById('ReorderPointInput'),
            document.getElementById('LeadTimeInput'),
            document.getElementById('MaxInput'),
            document.getElementById('MRPTypeInput'),
            document.getElementById('OutputTypeInput'),
            document.getElementById('comment2Input')
        ];

        inputs.forEach(input => {
            input.classList.remove('shake', 'input-error');
        });


    }

    function check(){
        console.log(surveyCreateVsUpdate)
    }

    window.onload = function () {
        const urlParams = new URLSearchParams(window.location.search);
        const myVariable = urlParams.get('scToken');
        StratCloudToken = urlParams.get('scToken');
        organizationUnit = urlParams.get('organizationUnit');
        embedReport(myVariable)
        document.getElementById('embed-container').style.visibility = 'hidden'

    };

    function openSpreadsheet(jsonData, fileInput) {
        ej.base.enableRipple(true);
        //Initialize Spreadsheet component
        var spreadsheet = new ej.spreadsheet.Spreadsheet({
            sheets: [
                {
                    name: 'Sheet 1',
                    ranges: [{ dataSource: jsonData }],
                }
            ],
            openUrl: 'https://services.syncfusion.com/js/production/api/spreadsheet/open',
            saveUrl: 'https://strategnos.sharepoint.com/sites/IT/_layouts/15/download.aspx?UniqueId=2cd3b7d3-3e24-4d5d-b6f5-e02dd376d936&Translate=false&tempauth=v1.eyJzaXRlaWQiOiI2YjQ5MDExMS1iZDE1LTQyZTktOGRlNy0yMDFmZjM1Nzg5M2MiLCJhcHBfZGlzcGxheW5hbWUiOiJTaGFyZVBvaW50QXBwIiwiYXVkIjoiMDAwMDAwMDMtMDAwMC0wZmYxLWNlMDAtMDAwMDAwMDAwMDAwL3N0cmF0ZWdub3Muc2hhcmVwb2ludC5jb21AODU4YTJiZDMtZmNkMi00NWVlLWI0NmMtZjkzNDgwM2JkMGIyIiwiZXhwIjoiMTcxOTgxODUwOCJ9.CgoKBHNuaWQSAjY0EgsInLKl84PojD0QBRoNMjAuMTkwLjE5MC4zNSosOGkycytQWU9BK3BJQjM3RzdOc0pJdlN3TDRNbUU3K2RHblNBM2xnUnkvbz0wggE4AUIQoTfyHB7gAJA_GTPZzb3KckoQaGFzaGVkcHJvb2Z0b2tlbnoBMboBH2FsbHNpdGVzLndyaXRlIGFsbHByb2ZpbGVzLnJlYWTCAUlkMTQ0ZDM0OC1iZTBiLTQ4MTUtYjM5YS02YjgyZjViZTY3N2JAODU4YTJiZDMtZmNkMi00NWVlLWI0NmMtZjkzNDgwM2JkMGIyyAEB.rwAO_IeK2AjXCkGJ6TH6_HNC1kSPta-TjnF0DHvn1Sg&ApiVersion=2.0',

        });
        //Render initialized Spreadsheet component
        spreadsheet.appendTo('#spreadsheet');
        console.log(spreadsheet)
        console.log(spreadsheet.workbookSaveModule.saveJSON.toString())
    }

    function uploadDocToSC(spreadsheet) {

        const myHeaders = new Headers();
        myHeaders.append("Authorization", "Bearer " + StratCloudToken);

        const formdata = new FormData();
        formdata.append("data", "{\"organizationUnitId\":89}");
        formdata.append("uploadedFile[]", spreadsheet);

        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: formdata,
            redirect: "follow"
        };

        fetch("https://demo.strategnosportal.co.za/OrganizationUnitDocuments/UploadDocument", requestOptions)
            .then((response) => response.text())
            .then((result) => console.log(result))
            .catch((error) => console.error(error));

        // Return the save URL
        return "https://demo.strategnosportal.co.za/OrganizationUnitDocuments/UploadDocument";
    }

    function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (file) {
            uploadDocToSC(file);
        } else {
            console.error('No file selected');
        }
    }

    function beforeSaving(){
        console.log("hit")
    }

    function embedReport(myVariable) {

        const myHeaders = new Headers();
        myHeaders.append("accept", "text/plain");
        myHeaders.append("Authorization", "Bearer " + myVariable);

        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };

        fetch("https://demo.strategnosportal.co.za/api/services/app/TenantDashboard/GetReportEmbedInfo?reportId=151", requestOptions)
            .then((response) => {
                if (!response.ok) {
                    // If the response status is not ok (e.g., 4xx or 5xx), throw an error
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json(); // Parse response as JSON if status is ok
            })
            .then((data) => {

                document.getElementById('newLineItemButton').style.display = 'block';
                const embedToken = data.result.embedParams.embedToken.token;
                const embedUrl = data.result.embedParams.embedReport[0].embedUrl;
                const reportId = data.result.embedParams.embedReport[0].reportId;

                let config = {
                    type: 'report',
                    accessToken: embedToken,
                    embedUrl: embedUrl,
                    tokenType: 1,
                    id: reportId,
                    permissions: models.Permissions.all,
                    settings: {
                        displayOption: models.DisplayOption.FitToPage,
                        panes: {
                            filters: {
                                visible: false
                            },
                            pageNavigation: {
                                visible: false
                            }
                        },
                        bars: {
                            statusBar: {
                                visible: false
                            }
                        },
                        extensions: [
                            {
                                command: {
                                    name: "campaign",
                                    title: "Start campaign",
                                    icon: 'ALT',
                                    extend: {
                                        visualOptionsMenu: {
                                            title: "Export to Spreadsheet"
                                        }
                                    }
                                }
                            }]
                            
                    }
                };
                
                const urlParams = new URLSearchParams(window.location.search);
                const nodeId = urlParams.get('nodeId');
                
                var nodeIdNumber = nodeId;

                // Get a reference to the embedded report HTML element
                let embedContainer = document.getElementById("embed-container");
                // Embed the report and display it within the div container.
                report = powerbi.embed(embedContainer, config);

                const taskFilter = {
                    $schema: "http://powerbi.com/product/schema#advanced",
                    target: {
                        table: "Query2",
                        column: "Code"
                    },
                    filterType: 0,
                    logicalOperator: "And",
                    conditions: [{
                        operator: "StartsWith",
                        value: nodeIdNumber
                    }]
                };

                const surveyFilter = {
                    $schema: "http://powerbi.com/product/schema#advanced",
                    target: {
                        table: "Query1",
                        column: "Code"
                    },
                    filterType: 0,
                    logicalOperator: "And",
                    conditions: [{
                        operator: "StartsWith",
                        value: nodeIdNumber
                    }]
                };


                // Apply the filter once the report is loaded
                report.on("loaded", function() {    
                    document.getElementById('embed-container').style.visibility = 'visible'
                    document.getElementById('loading-overlay').style.display = 'none';

                    report.updateFilters(models.FiltersOperations.Add, [taskFilter,surveyFilter])
                        .then(function() {
                            console.log("Report filter was added.");
                        })
                        .catch(function(errors) {
                            console.log(errors);
                        });
                });

                // report.on will add an event listener.
                report.on("dataSelected", function (event) {
                    let data = event.detail;
                    if(data.visual.name === '6e717e20e3465899e056'){

                        surveyCreateVsUpdate = 'update';
                        document.getElementById('survey-card').style.display = 'block';
                        document.getElementById('newLineItemButton').style.display = 'none';

                        console.log(data)
                        
                        reorderPoint = data.dataPoints[0].identity[8].equals;
                        mrpType = data.dataPoints[0].identity[4].equals;
                        max = data.dataPoints[0].identity[3].equals;
                        outputType = data.dataPoints[0].identity[6].equals;
                        leadTime = data.dataPoints[0].identity[1].equals;
                        materialCode = data.dataPoints[0].identity[2].equals;
                        comments = data.dataPoints[0].identity[0].equals;
                        userSurveyId = data.dataPoints[0].identity[7].equals;
                        surveyOrganizationUnitId = data.dataPoints[0].identity[5].equals;
                        
                        console.log(userSurveyId)

                        document.getElementById('MaterialCodeInput').value = materialCode;
                        document.getElementById('ReorderPointInput').value = Number(reorderPoint);
                        document.getElementById('LeadTimeInput').value = Number(leadTime);
                        document.getElementById('MaxInput').value = Number(max);
                        document.getElementById('MRPTypeInput').value = mrpType;
                        document.getElementById('OutputTypeInput').value = outputType;
                        document.getElementById('comment2Input').value = comments;



                    }else{
                    taskName = data.dataPoints[0].identity[0].equals;
                    taskStartDate = data.dataPoints[0].identity[1].equals;
                    taskEndDate = data.dataPoints[0].identity[2].equals;
                    note = data.dataPoints[0].identity[3].equals;
                    noteOrganizationUnitID = data.dataPoints[0].identity[4].equals;
                    noteId = data.dataPoints[0].identity[5].equals;
                    notesEnabled = data.dataPoints[0].identity[6].equals;

                    // Convert to Date object
                    const StartDate = new Date(taskStartDate);
                    const EndDate = new Date(taskEndDate);

                    // Format date as YYYY-MM-DDTHH:MM
                    const formattedStartDate = StartDate.toISOString().slice(0, 16);
                    const formattedEndDate = EndDate.toISOString().slice(0, 16);

                    document.getElementById("taskNameInput").value = taskName;
                    document.getElementById("startDateInput").value = formattedStartDate;
                    document.getElementById("endDateInput").value = formattedEndDate;
                    document.getElementById('commentInput').value = note;

                    var form = document.getElementById('forms-card');
                    form.style.display = 'block';

                    var submitButton = document.getElementById('submitComment');
                    submitButton.style.display = 'block';
                    }

                });

                report.on("commandTriggered", async function (event) {

                    const pages = await report.getPages();

                    // Retrieve the page that contain the visual. For the sample report it will be the active page
                    let page = pages.filter(function (page) {
                        return page.isActive
                    })[0];

                    page.updateFilters(models.FiltersOperations.Add, [filter]);
                    console.log("Page filter was added.");

                    const visuals = await page.getVisuals();

                    console.log(visuals)

                    // Retrieve the target visual.
                    let visual = visuals.filter(function (visual) {
                        return visual.name === "e2cd66f842406a483576";
                    })[0];

                    // Exports visual data
                    const result = await visual.exportData();

                    console.log(result)

                    // Assuming result.data is a CSV string
                    const csvData = result.data;

                    Papa.parse(csvData, {
                        header: true,  // Treat the first row as headers
                        complete: function (results) {
                            // 'results.data' now contains the parsed JSON data
                            const jsonData = results.data;
                            console.log(jsonData)

                            // You can do something with the JSON data here
                            openSpreadsheet(jsonData);

                        }
                    });
                })
                

                report.on("buttonClicked", async function (event) {
                    if (event.detail.title === "Refresh") {
                        try {
                            await report.refresh();
                            console.log("Refreshed");
                        }
                        catch (errors) {
                            console.log(errors);
                        }
                    }
                    else if (event.detail.title === "Edit") {
                        report.switchMode("edit");
                    }
                });
                
            }).catch((error) => {
                // Handle errors
                console.error('There was a problem with the fetch operation:', error);
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('error-container').style.display = 'flex';

            });
    }

    function createOrUpdateNote(){
        console.log(notesEnabled)

        var currentdate = new Date(); 
        var datetime = currentdate.getDate() + "/"
                        + (currentdate.getMonth()+1)  + "/" 
                        + currentdate.getFullYear() + " @ "  
                        + currentdate.getHours() + ":"  
                        + currentdate.getMinutes() + ":" 
                        + currentdate.getSeconds();
        console.log(datetime)

        if(notesEnabled === "App.Notes"){
        
            const myHeaders = new Headers();
            myHeaders.append("accept", "*/*");
            myHeaders.append("Content-Type", "application/json-patch+json");
            myHeaders.append("X-XSRF-TOKEN", "null");
            myHeaders.append("Authorization", "Bearer " + StratCloudToken);

            const raw = JSON.stringify({
            "organizationUnitId": noteOrganizationUnitID,
            "createOrUpdateNote": {
                "notes": document.getElementById("commentInput").value,
                "id": noteId
            }
            });

            const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
            };

            fetch("https://demo.strategnosportal.co.za/api/services/app/OrganizationUnitNote/CreateOrUpdateNote", requestOptions)
            .then((response) => response.text())
            .then((result) => {
                console.log(result);
                showNotification("<i class='fa-regular fa-thumbs-up fa-bounce'></i> Note created or updated successfully!", 'success');
            })
            .catch((error) => console.error(error));
        }
            else{
                console.log("Notes feature is not enabled", 'error')
                showNotification("<i class='fa-solid fa-exclamation fa-shake'></i> Notes feature is not enabled.", 'error');
            }
    }
    
    function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.className = 'notification'; // reset classes
            notification.classList.add(type);
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
        }, 3000);
    }

    function updateSurveyResult(){

        const inputs = [
            document.getElementById('MaterialCodeInput'),
            document.getElementById('ReorderPointInput'),
            document.getElementById('LeadTimeInput'),
            document.getElementById('MaxInput'),
            document.getElementById('MRPTypeInput'),
            document.getElementById('OutputTypeInput'),
            document.getElementById('comment2Input')
        ];

        let isValid = true;

        inputs.forEach(input => {
            if (input.value.trim() === '') {
                input.classList.add('shake', 'input-error');
                isValid = false;
            } else {
                input.classList.remove('shake', 'input-error');
            }
        });
        

        // Check if any input is empty
        if (!isValid) {
            console.log('hit')
        }
        else{
            if(surveyCreateVsUpdate === 'update'){
                console.log(comments)

                const myHeaders = new Headers();
                myHeaders.append("accept", "*/*");
                myHeaders.append("Content-Type", "application/json-patch+json");
                myHeaders.append("X-XSRF-TOKEN", "null");
                myHeaders.append("Authorization", "Bearer " + StratCloudToken);

                var raw = JSON.stringify({
                "surveyId": "a31a0398-b597-4321-e343-08dc9f3c4ca5",
                "userToken": userSurveyId,
                "organizationUnitId": surveyOrganizationUnitId,
                "surveyResultsAsJson": JSON.stringify({
                    "reorderPoint": document.getElementById('ReorderPointInput').value,
                    "max": document.getElementById('MaxInput').value,
                    "leadTime": document.getElementById('LeadTimeInput').value,
                    "mrpType": document.getElementById('MRPTypeInput').value,
                    "comment": document.getElementById('comment2Input').value,
                    "outputType": document.getElementById('OutputTypeInput').value,
                    "materialCode": document.getElementById('MaterialCodeInput').value
                }),
                "tenantId": 14,
                "editing": "true"
                });

                const requestOptions = {
                    method: "POST",
                    headers: myHeaders,
                    body: raw,
                    redirect: "follow"
                };

                fetch("https://demo.strategnosportal.co.za/api/services/app/Forms/SaveCompletedSurveyResults", requestOptions)
                .then((response) => response.text())
                .then((result) => 
                    showNotification("<i class='fa-regular fa-thumbs-up fa-bounce'></i> Created or updated successfully!", 'success'
                ))
                .catch((error) => 
                    showNotification("<i class='fa-solid fa-exclamation fa-shake'></i> Notes feature is not enabled.", 'error')
                );
            }else if (surveyCreateVsUpdate === 'create'){

                const urlParams = new URLSearchParams(window.location.search);
                const organizationUnit = urlParams.get('organizationUnit');

                console.log(organizationUnit);

                const requestOptions = {
                    method: "GET",
                    redirect: "follow"
                };

                // Construct the URL with the organizationUnit
                const url = `https://demo.strategnosportal.co.za/api/services/app/SurveysAnonymous/GetSurveyToComplete?OrganizationUnitId=${organizationUnit}&Id=a31a0398-b597-4321-e343-08dc9f3c4ca5`;

                fetch(url, requestOptions)
                    .then((response) => response.text())
                    .then((result) => {
                        const jsonResult = JSON.parse(result); // Parse the text as JSON
                        if (jsonResult && jsonResult.result && jsonResult.result.userToken) {
                            const surveyUserToken = jsonResult.result.userToken; 
                            console.log(surveyUserToken)
                            // Extract the userToken
                                //SECOND CALL
                                const myHeaders = new Headers();
                                myHeaders.append("Content-Type", "application/json");

                                const raw = JSON.stringify({
                                "surveyId": "a31a0398-b597-4321-e343-08dc9f3c4ca5",
                                "userToken": surveyUserToken,
                                "organizationUnitId": Number(organizationUnit),
                                "surveyResultsAsJson": JSON.stringify({
                                    "reorderPoint": document.getElementById('ReorderPointInput').value,
                                    "max": document.getElementById('MaxInput').value,
                                    "leadTime": document.getElementById('LeadTimeInput').value,
                                    "mrpType": document.getElementById('MRPTypeInput').value,
                                    "comment": document.getElementById('comment2Input').value,
                                    "outputType": document.getElementById('OutputTypeInput').value,
                                    "materialCode": document.getElementById('MaterialCodeInput').value
                                }),
                                "tenantId": 14
                                });

                                const requestOptions2 = {
                                method: "POST",
                                headers: myHeaders,
                                body: raw,
                                redirect: "follow"
                                };

                                fetch("https://demo.strategnosportal.co.za/api/services/app/SurveysAnonymous/SaveCompletedSurveyResults", requestOptions2)
                                .then((response) => response.text())
                                .then((result) => console.log(result))
                                .catch((error) => console.error(error));
                        } else {
                            console.error('userToken is undefined or not present in the response');
                        }
                    })
                    .catch((error) => console.error('Error:', error));




                
            }
        }
    }

    function createNewLineItem() {
        surveyCreateVsUpdate = 'create'
        document.getElementById('survey-card').style.display = 'block';
        document.getElementById('newLineItemButton').style.display = 'none';
        
        document.getElementById('MaterialCodeInput').value = '';
        document.getElementById('ReorderPointInput').value = '';
        document.getElementById('LeadTimeInput').value = '';
        document.getElementById('MaxInput').value = '';
        document.getElementById('MRPTypeInput').value = '';
        document.getElementById('OutputTypeInput').value = '';
        document.getElementById('comment2Input').value = '';
    }

document.addEventListener('DOMContentLoaded', () => {
    const inputs = [
        document.getElementById('MaterialCodeInput'),
        document.getElementById('ReorderPointInput'),
        document.getElementById('LeadTimeInput'),
        document.getElementById('MaxInput'),
        document.getElementById('MRPTypeInput'),
        document.getElementById('OutputTypeInput'),
        document.getElementById('comment2Input')
    ];

        inputs.forEach(input => {
            input.addEventListener('input', () => {
                if (input.value.trim() !== '') {
                        input.classList.remove('shake', 'input-error');
                }
                });
            });
        });

</script>